<div class="product-page">
  @if (loading) {
    <div class="loading">
      <p>Loading product details...</p>
    </div>
  }

  @if (error) {
    <div class="error">
      <h2>Product Not Found</h2>
      <p>The product you're looking for doesn't exist or has been removed.</p>
      <button class="back-button" (click)="goBack()">Go Back</button>
    </div>
  }

  @if (product() && !loading && !error) {
    <div class="product-container">
      <button class="back-button" (click)="goBack()">← Back</button>

      <div class="product-header">
        @if (!isEditing()) {
          <div class="product-title-display">
            <h1>{{ product()?.name }}</h1>
            <span class="product-id">#{{ product()?.id }}</span>
            @if (isOwner()) {
              <button class="edit-button" (click)="startEditing()" title="Edit product">✏️</button>
            }
          </div>
        } @else {
          <div class="product-title-edit">
            <input 
              type="text" 
              [(ngModel)]="editedName" 
              class="edit-title-input"
              placeholder="Product name"
            />
            <span class="product-id">#{{ product()?.id }}</span>
          </div>
        }
      </div>

      <div class="product-details">
        <div class="product-images">
          @if (product()?.imagesUrl && product()!.imagesUrl.length > 0) {
            <div class="image-gallery">
              @for (image of product()?.imagesUrl; track image) {
                <div class="image-item">
                  <img [src]="getImageUrl(image)" [alt]="'Product image'" />
                  @if (isOwner()) {
                    <button class="delete-image" (click)="deleteImage(image)" title="Delete image">×</button>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="no-images">
              <p>No images available for this product</p>
            </div>
          }
          
          @if (isOwner()) {
            <div class="image-upload">
              <h3>Add Images</h3>
              <input 
                type="file" 
                multiple 
                accept="image/*"
                (change)="onFileSelect($event)"
              />
              @if (selectedFiles.length > 0) {
                <div class="selected-files">
                  <p>{{ selectedFiles.length }} file(s) selected</p>
                  <button 
                    class="upload-button" 
                    (click)="uploadImages()" 
                    [disabled]="uploadProgress"
                  >
                    {{ uploadProgress ? 'Uploading...' : 'Upload Images' }}
                  </button>
                </div>
              }
              @if (uploadMessage) {
                <div class="upload-message" [class.error]="uploadMessage.includes('Failed')">
                  {{ uploadMessage }}
                </div>
              }
            </div>
          }
        </div>

        <div class="product-info">
          <div class="product-category">
            <span class="category-label">Category:</span>
            <span class="category-name">{{ product()?.category?.name }}</span>
          </div>

          <div class="product-owner">
            <span class="owner-label">Seller:</span>
            <span class="owner-name">{{ product()?.owner?.name }}</span>
          </div>
        </div>

        <div class="product-description">
          <div class="description-header">
            <h2>Description</h2>
            @if (isOwner() && !isEditing()) {
              <button class="edit-button-small" (click)="startEditing()" title="Edit description">✏️</button>
            }
          </div>
          @if (!isEditing()) {
            <p>{{ product()?.description }}</p>
          } @else {
            <textarea 
              [(ngModel)]="editedDescription" 
              class="edit-description-input"
              placeholder="Product description"
              rows="4"
            ></textarea>
          }
        </div>

        <div class="product-actions">
          @if (isEditing()) {
            <div class="edit-actions">
              <button 
                class="save-button" 
                (click)="saveChanges()" 
                [disabled]="updateProgress || !editedName().trim() || !editedDescription().trim()"
              >
                {{ updateProgress ? 'Saving...' : 'Save Changes' }}
              </button>
              <button 
                class="cancel-button" 
                (click)="cancelEditing()" 
                [disabled]="updateProgress"
              >
                Cancel
              </button>
            </div>
          } @else {
            <button class="contact-button" (click)="contactSeller()">
              Contact Seller
            </button>
          }
          
          @if (updateMessage) {
            <div class="update-message" [class.error]="updateMessage.includes('Failed')">
              {{ updateMessage }}
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
